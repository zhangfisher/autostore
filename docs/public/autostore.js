var AutoStoreSpaces=(function(exports){'use strict';var Kt=Object.defineProperty;var n=(e,t)=>Kt(e,"name",{value:t,configurable:true}),S=(e=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(e,{get:(t,i)=>(typeof require<"u"?require:t)[i]}):e)(function(e){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+e+'" is not supported')});function N(e,...t){if(t.length===0)return e;let i=t.map((r,s)=>{let o=Object.entries(r||{});return o.some(([a,u])=>u===void 0)?o.reduce((a,[u,f])=>(f!==void 0&&(a[u]=f),a),{}):r});return Object.assign(e,...i)}n(N,"u");function Y(e){return e!=null&&typeof e[Symbol.iterator]=="function"&&typeof e!="string"}n(Y,"t");function b(e){if(typeof e!="object"||e===null)return  false;var t=Object.getPrototypeOf(e);if(t===null)return  true;for(var i=t;Object.getPrototypeOf(i)!==null;)i=Object.getPrototypeOf(i);return t===i}n(b,"o");function jt(e,t=false){if(typeof e=="number")return  true;if(typeof e!="string"||t)return  false;try{if(e.includes(".")){let i=parseFloat(e);return e.endsWith(".")?!isNaN(i)&&String(i).length===e.length-1:!isNaN(i)&&String(i).length===e.length}else {let i=parseInt(e);return !isNaN(i)&&String(i).length===e.length}}catch{return  false}}n(jt,"r");function R(e){if(jt(e)||typeof e=="boolean"||typeof e=="function"||e instanceof Error)return  false;if(e==null||e==null||Array.isArray(e)&&e.length==0||b(e)&&Object.keys(e).length==0||typeof e=="string"&&e.trim()=="")return  true;try{if(Y(e)&&e.size==0)return !0}catch{}return  false}n(R,"s");function St(e,{empty:t,delimiter:i=","}){let r=e;try{return typeof r=="function"&&(r=r.call(this,r)),R(r)&&(r=t||""),Array.isArray(r)?r.map(s=>String(s)).join(i):b(r)?Object.entries(r).reduce((s,[o,a])=>(s.push(`${o}=${String(a)}`),s),[]).join(i):Y(r)&&typeof r!="string"?[...r].map(s=>String(s)).join(i):r instanceof Error?r.message:String(r)}catch{return String(r)}}n(St,"h");var qt=/\{(\<(.*?)\>)?\s*([^\{\}\>\<]*)(?<!\s)\s*(\<(.*?)\>)?\}/gm;function _t(e,t,i){let r,s=N({empty:null,delimiter:",",forEach:null},i);typeof t=="function"&&(t=t.call(e)),Array.isArray(t)&&t.length==1&&(b(t[0])||Array.isArray(t[0]))&&(t=t[0]),["boolean","string","number"].includes(typeof t)?r=[t]:t instanceof Map?r=[...t.entries()].reduce((a,u)=>(a[u[0]]=u[1],a),{}):Symbol.iterator in t?r=[...t]:b(t)?r=t:t instanceof Error?r=[`Error:${t.message}`]:r=[t];let o=0;return e.replaceAll(qt,function(){let a=arguments[2]||"",u=arguments[3]||"",f=arguments[5]||"",l="",c=false;if(Array.isArray(r)){let p=o>=r.length;l=p?"":St.call(e,r[o],s),c=R(l)||p,o++;}else if(b(r)){let p=u in r;l=p?St.call(e,r[u],s):"",c=R(l)||!p;}if(typeof s.forEach=="function"){let p=s.forEach(u,l,a,f);p!==void 0&&(Array.isArray(p)&&p.length==3?(a=p[0],l=p[1],f=p[2]):R(p)||(l=String(p)),c=R(l));}return c&&(s.empty==null?(l="",a="",f=""):l=s.empty),`${a}${l}${f}`})}n(_t,"x");function Tt(e,...t){let i=e.valueOf(),r={},s=[...t];if(t.length>0&&b(t[t.length-1])){let o=t[t.length-1];("$delimiter"in o||"$empty"in o||"$forEach"in o)&&("$delimiter"in o&&(r.delimiter=o.$delimiter),"$empty"in o&&(r.empty=o.$empty),"$forEach"in o&&(r.forEach=o.$forEach),s.pop());}try{return s.length==1?_t(i,s[0],r):_t(i,[...s],r)}catch{return i}}n(Tt,"o");String.prototype.params=function(){return Tt(this,...arguments)};function Yt(e,t,i){if(typeof t=="string"){let r=0,s;for(;(s=e.indexOf(t,r))>-1;){let o=typeof i=="function"?i(t):i,a=e.length;e=e.substring(0,s)+o+e.substring(s+t.length),r=s+o.length+e.length-a;}}else {let r;if(!t.global||!t.multiline)throw new Error("The search parameter must be enabled '/gm' option");for(;(r=t.exec(e))!==null;){r.index===t.lastIndex&&t.lastIndex++;let s=e.length,o=r[0].length,a=typeof i=="function"?i(r[0],...r):i;e=e.substring(0,r.index)+a+e.substring(r.index+o),t.lastIndex+=e.length-s;}}return e}n(Yt,"s");String.prototype.replaceAll||(String.prototype.replaceAll=function(e,t){return Yt(this,e,t)});(e=>typeof S<"u"?S:typeof Proxy<"u"?new Proxy(e,{get:n((t,i)=>(typeof S<"u"?S:t)[i],"get")}):e)(function(e){if(typeof S<"u")return S.apply(this,arguments);throw Error('Dynamic require of "'+e+'" is not supported')});var O=class extends Error{static{n(this,"AutoStoreError");}},H=class extends O{static{n(this,"AbortError");}},V=class extends O{static{n(this,"TimeoutError");}},X=class extends O{static{n(this,"CyleDependError");}},z=class extends O{static{n(this,"InvalidComputedArgumentsError");}},Z=class extends O{static{n(this,"InvalidScopeError");}},J=class extends O{static{n(this,"InvalidDependsError");}},Q=class extends O{static{n(this,"ValidateError");}behavior="throw"};var k="__AS_SKIP_PROXY__",C="__AS_OBSERVER_DESCRIPTOR_BUILDER__",Rt="__AS_OBSERVER_DESCRIPTOR__",h=".",Vt="__batch_update__",tt="__AS_ASYNC_COMPUTED_VALUE__",xr="__AS_EMPTY__",D="__AS_VALUE_SCHEMA__",Ar="__AS_DELETE_FLAG__";function et(e){return e.constructor.name==="AsyncFunction"}n(et,"isAsyncFunction");function bt(e){return e?e.map(t=>Array.isArray(t)?t:typeof t=="string"?["/","./","../"].some(i=>t.startsWith(i))?t:t.includes(".")?t.split("."):t.split("."):[]):[]}n(bt,"normalizeDeps");function rt(){return {async:false,enable:true,timeout:0,depends:[],immediate:"auto",extras:void 0,objectify:true}}n(rt,"getDefaultComputedOptions");function it(){let e=arguments[0];if(typeof e!="function")throw new Error("computed getter must be a function");let t=[],i=Object.assign({},rt());if(arguments.length===1)t=[];else if(arguments.length===2)if(Array.isArray(arguments[1]))i.depends=arguments[1];else if(typeof arguments[1]=="object")Object.assign(i,arguments[1]),i.depends=bt(i.depends);else throw new z;else arguments.length>=3&&(t=bt(arguments[1]),Object.assign(i,arguments[2]),i.depends=t);i.async=i.async===true||et(e)||arguments.length>=2&&Array.isArray(arguments[1]);let r=n(()=>({type:"computed",getter:e,options:i,[Rt]:true}),"descriptorBuilder");return r[C]=true,r}n(it,"computed");function xt(e){return e?e.some(t=>typeof t=="string"?t.startsWith("./")||t.startsWith("../")||t.startsWith("@")?false:!["CURRENT","SELF","PARENT"].includes(t):true):false}n(xt,"isAbsolutePath");function w(e){return typeof e=="object"&&e.hasOwnProperty("type")&&typeof e.type=="string"&&e.hasOwnProperty("getter")&&typeof e.getter=="function"&&e.hasOwnProperty("options")&&typeof e.options=="object"}n(w,"isObserverDescriptor");function G(e){try{return e[k]===!0}catch{}return  false}n(G,"isRaw");function st(e,t){if(e===t)return  true;if(e===null||t===null||typeof e!=typeof t)return  false;if(typeof e=="object"){if(Array.isArray(e)&&Array.isArray(t))return e.length!==t.length?false:e.every((i,r)=>st(i,t[r]));if(!Array.isArray(e)&&!Array.isArray(t)){let i=Object.keys(e);return i.length!==Object.keys(t).length?false:i.every(r=>st(e[r],t[r]))}else return  false}return  false}n(st,"isEq");function P(e){return toString.call(e)==="[object Map]"}n(P,"isMap");function j(e,t){return !e||!t||e.length!==t.length?false:e.every((i,r)=>i===t[r])}n(j,"isPathEq");function ot(e,t){let i=Array.isArray(e)?e:e.split("."),r=Array.isArray(t)?t:t===""?[]:t.split(".");return r.length===0||j(i,r)?true:(r[r.length-1]==="**"&&(r[r.length-1]="*",r.splice(r.length-1,0,...Array.from({length:i.length-r.length}).fill("*"))),i.length!==r.length?false:r.every((o,a)=>o==="*"||o==="**"?true:o===i[a]))}n(ot,"isPathMatched");function Ct(e){return e==null||typeof e!="object"?false:Object.prototype.toString.call(e)==="[object Object]"}n(Ct,"isPlainObject");function _(e){return e&&typeof e=="object"&&e.hasOwnProperty(tt)}n(_,"isAsyncComputedValue");function Dt(e){try{return !!e&&(typeof e=="object"||typeof e=="function")&&typeof e.then=="function"&&typeof e.catch=="function"&&(e instanceof Promise||Object.prototype.toString.call(e)==="[object Promise]")}catch{return  false}}n(Dt,"isPromise");function I(e){return typeof e=="function"&&e[C]===true}n(I,"isObserverDescriptorBuilder");function fi(e){return typeof e=="object"&&e!==null&&!("__isProxy"in e)}n(fi,"isProxy");function nt(e,t){let i=e.get(t);if(i!==void 0)return i;let r=e.get(Number(t)||t);if(r!==void 0)return r}n(nt,"getMapVal");function g(e,t,i){if(!t||t.length===0)return e;let r=Array.isArray(t)?t:t.split("."),s,o=e;for(let a=0;a<r.length;a++){let u=r[a];if(P(o))s=nt(o,u);else if(u in o)s=o[u];else return i;o=s;}return s}n(g,"getVal");function x(e){try{["object","function"].includes(typeof e)&&(e[k]=!0);}catch{}return e}n(x,"markRaw");function E(e,t,i,r){if(!t||!e)return e;let s=t;if(s.length===0)return typeof e=="object"&&Object.assign(e,i),e;{let o=e,a=[],u=n((f,l,c)=>{r&&_(f[l])?f[l].value=c:f[l]=c;},"update");for(let f=0;f<s.length;f++){let l=s[f];if(a.push(l),o)if(Array.isArray(o)){let c=parseInt(l,10);if(Number.isNaN(c)||c<0)throw new Error(`setVal: invalid array index ${a.join(".")}`);f===s.length-1?u(o,c,i):o=o[c];}else o instanceof Map||o instanceof WeakMap?f===s.length-1?o.set(l,i):(o.has(l)||o.set(l,{}),o=o.get(l)):typeof o=="object"&&l in o?f===s.length-1?u(o,l,i):o=o[l]:(o[l]=f===s.length-1?i:{},o=o[l]);else o[l]=f===s.length-1?i:{},o=o[l];}}return e}n(E,"setVal");function $(e){return (e||["ROOT"]).map(t=>Array.isArray(t)?t.join("."):t).join(".")}n($,"joinValuePath");function at(){return Math.random().toString(36).slice(2)}n(at,"getId");function K(e,t,i){let r=e&&!e[0].startsWith("#");if(Array.isArray(t))return t;if(t==="self")return r?e:void 0;if(t==="root")return r?[]:void 0;if(t==="parent")return r?e.slice(0,-2):void 0;if(t==="current")return r?e.slice(0,-1):void 0;if(typeof t=="string")return t.startsWith("./")?r?[...e.slice(0,-1),...t.slice(2).split(".")]:void 0:t.startsWith("../")?r?K(e.slice(0,-1),t.slice(3),true):void 0:t.startsWith("/")?t.replace(/^(\/)*/,"").split("."):r&&i?[...e.slice(0,-1),...t.split(".")]:t.split(".")}n(K,"getFullValuePath");function M(e,t){return t?t.map(i=>K(e,i)).filter(i=>i!==void 0):[]}n(M,"calcDependPaths");function Li(e,t){let i="";return t.id?i=t.id:i=$(e),i}n(Li,"getComputedId");function Pt(e,t,i){let r=e,s=t.length-1;t.forEach((o,a)=>{let u=P(r);if(a===s){let f=u?r.get(o):r[o];typeof f=="object"&&Object.assign(f,i);return}u?(r.has(o)||r.set(o,{}),r=r.get(o)):(o in r||(r[o]={}),r=r[o]);});}n(Pt,"updateObjectVal");function ut(e,t){function i(r,s){for(let o in r){let a=r[o];typeof t=="function"&&t({value:a,key:o,parent:r,path:s.concat(o)}),typeof a=="object"&&!G(a)&&i(a,s.concat(o));}}n(i,"_forEachObject"),i(e,[]);}n(ut,"forEachObject");function Xt(e){return e}n(Xt,"getSnap");function zi(e=1e3){return new Promise(t=>{setTimeout(t,e);})}n(zi,"delay");function lt(e){let t=new Map;return e.forEach(i=>{let r=i.join(".");t.set(r,i);}),Array.from(t.values())}n(lt,"noRepeat");function ts(e,t){return e.length>t.length?false:e.every((i,r)=>i===t[r])}n(ts,"pathStartsWith");function ns(e,t,i){let r=[];return typeof e=="function"?r=t.collectDependencies(()=>e(t.state)):typeof e=="string"?r=[e.split(".")]:Array.isArray(e)?r=[[...e]]:r=[],i!=="none"&&r.forEach(s=>{let o=t.peep(a=>g(a,s));_(o)&&s.push(i==="all"?"*":"value");}),r}n(ns,"getDepends");function cs(e,t){if(!t||t.length===0)return  false;let i,r=e;for(let s=0;s<t.length;s++){let o=t[s],a=false;if(P(r)){if(a=r.has(o),!a)return  false;i=nt(r,o);}else {if(a=o in r,!a)return  false;i=r[o];}r=i;}return  true}n(cs,"pathIsExists");function A(e){return e?typeof e=="function":false}n(A,"isFunction");function ft(e,t){let{reserveAsync:i,includeFunc:r}=Object.assign({reserveAsync:false},t);if(Array.isArray(e)){let s=[...e];for(let o=0;o<s.length;o++)s[o]=ft(s[o],t);return s}else if(typeof e=="object"){if(!i&&_(e))return e.value;{let s={...e};for(let o in s)s[o]=ft(s[o],t);return s}}return r&&A(e)?`\`\`\`${e.toString()}\`\`\``:e}n(ft,"getSnapshot");function xs(e){return e==null||typeof e=="string"||typeof e=="number"||typeof e=="boolean"}n(xs,"isPrimitive");function Es(e){globalThis.__AUTOSTORE_EXTENDS__&&(globalThis.__AUTOSTORE_EXTENDS__=[]),typeof e=="function"&&globalThis.__AUTOSTORE_EXTENDS__.push(e);}n(Es,"defineExtend");function Rs(e,t,i){let r=I(t)?t():t;if(w(r)){if(r.options.objectify=false,Object.assign(r.options,i),r.type==="computed")return e.computedObjects.create(r);if(r.type==="watch")return e.watchObjects.create(r)}else if(typeof r=="function"){let o=it(r)();return o.options.objectify=false,Object.assign(o.options,i),e.computedObjects.create(o)}}n(Rs,"createObserverObject");function Is(e){return w(e)||I(e)}n(Is,"isComputedDescriptorParameter");function Ws(e,t,i){let r=g(e,typeof t=="string"?t.split("."):t,i);return _(r)?r:{value:r,loading:false,retry:0,error:null,timeout:0,progress:0,run:n(()=>{},"run"),cancel:n(()=>{},"cancel")}}n(Ws,"getAsyncVal");function Gs(e,t){return _(e)?Object.assign({},e,t):Object.assign({value:e,loading:false,retry:0,progress:0,timeout:0,error:null,run:n(()=>{},"run"),cancel:n(()=>{},"cancel")},t)}n(Gs,"createAsyncComptuedValue");function Xs(e){try{return e[D]===!0}catch{}return  false}n(Xs,"isValueSchema");function Js(e){let t=Array.isArray(e)?e[0]:e;return !!(t.startsWith("./")||t.startsWith("../")||["CURRENT","PARENT","SELF"].includes(t))}n(Js,"isRelPath");function ct(e){return typeof e=="function"&&e[D]===true}n(ct,"isSchemaBuilder");var pt=class extends Map{static{n(this,"ComputedObjects");}store;constructor(t){super(),this.store=t;}get enable(){return this.store.options.enableComputed}set enable(t){this.store.options.enableComputed=t;}create(){let t=w(arguments[0])?arguments[0]:it(...arguments)();if(t.options.async&&!xt(t.options.depends))throw new J("The scope of the dynamic computed object must be the root state object or an absolute path");let i=t.options.scope;if(i===void 0||i==="ROOT")t.options.scope="ROOT";else if(!xt([i]))throw new Z("The scope of the dynamic computed object must be the root state object or an absolute path");return this.store._createComputed(t)}async runGroup(t,i,r){return await this.run(s=>s.group===t,i,r)}async run(){if(arguments.length===0)return Promise.all([...this.values()].map(o=>o.run()));let t;typeof arguments[0]=="function"?t=arguments[0]:typeof arguments[0]=="string"&&(t=n(o=>o.id===arguments[0],"filter"));let i=Object.assign({},arguments[1]),r=Object.assign({wait:false,timeout:0},arguments[2]),s={};return new Promise((o,a)=>{if(r.wait){let u;i.onDone=({id:f})=>{if(s[f]=true,Object.values(s).every(l=>l))return clearTimeout(u),true},r.timeout>0&&(u=setTimeout(()=>{a(new V);},r.timeout));}Promise.all([...this.values()].filter(u=>t(u)?(s[u.id]=false,true):false).map(u=>u.run(i))),r.wait||o();})}async enableGroup(t){for(let i of this.values())i.options.enable=t;}delete(t){return this.get(t)?.detach(),super.delete(t)}find(t){if(!t)return;let i=Array.isArray(t)?t:t.split(".");for(let r of this.values())if(j(r.path,i))return r}};function It(e,t="info"){let i=typeof e=="function"?e():e instanceof Error?e.stack:e;try{console[t](`[AutoStore<${this.id}>]`,...Array.isArray(i)?i:[i]);}catch{}}n(It,"log");function B(e,t,i="."){let r=[];try{return typeof t=="function"&&(t=t.call(e,e)),r=Array.isArray(t)?t:typeof t=="string"?t.split(i):[],r.length>0?g(e,r):e}catch{return e}}n(B,"getValueByPath");var L=(function(e){return e.Root="ROOT",e.Current="CURRENT",e.Parent="PARENT",e.Depends="DEPENDS",e.Self="SELF",e})({});function zt(e,t,i){let r=t===void 0?i:t;if(typeof r=="function")try{r=r.call(e.store,e);}catch{}return r===void 0?i===void 0?L.Current:i:r}n(zt,"getScopeOptions");function F(e,t,i,r){let s=e.store.state,o=e.store.options;if(typeof o.getRootScope=="function"){let c=o.getRootScope(e,{observerType:t,valuePath:i?.path});c!==void 0&&(s=c);}let{path:a,parentPath:u}=i||{},f=zt(e,r.scope,o.scope),l=s;try{f===L.Current?l=B(s,u):f===L.Parent?l=B(s,a.slice(0,a.length-2<0?0:a.length-2)):f===L.Root?l=s:f===L.Depends?l=e.depends?.map(c=>B(s,c)):typeof f=="string"?f.startsWith("@")?l=F(e,t,i,{...r,scope:F(e,t,{...i,path:f.slice(1).split(".")},{...r,scope:f.slice(1)})}):l=B(s,K(e.path,f)):Array.isArray(f)&&(l=B(s,f));}catch(c){o.log(`Error while getting computed scope ${e.toString()}: ${c.message}`,"error");}return l}n(F,"getValueScope");var W=class{static{n(this,"ObserverObject");}descriptor;context;_path;_id="";_initial;_value;_associated=false;_attached=false;_getter;_depends=[];_options;_subscribers=[];_strPath;_error;store;_shadowStore;constructor(t,i,r){this.descriptor=i,this.context=r,this.store=t,this._associated=r!==void 0,this._getter=i.getter,this._options=Object.assign({enable:true,group:"",depends:[],throwError:true},i.options),this._id=this._options.id||(this._associated?$(r?.path):at()),this._path=r?.path||[`#${this._id}`],this._path||(this._path=[`#${this._id}`]),this._initial=this._options.initial,this.onInitOptions(this._options),this._depends=M(this._path,this._options.depends),this._onObserverCreated(),this._onInitial();}get type(){return this.descriptor.type}get options(){return this._options}get id(){return this._id}get associated(){return this._associated}get async(){return this._options.async}get enable(){return this._options.enable}set enable(t){this._options.enable=t;}set group(t){this._options.group=t;}get group(){return this._options.group}get initial(){return this._initial}set initial(t){this._initial=t;}get path(){return this._path}get attached(){return this._attached}get depends(){return this._depends}set depends(t){this._depends=t;}get getter(){return this._getter}set getter(t){this._getter=t;}get strPath(){return this._strPath||(this._strPath=this._path.join(".")),this._strPath}get error(){return this._error}set error(t){this._error=t;}toString(){return `ObserverObject<${this.strPath}>`}get value(){return this._associated?g(this.store.state,this._path):(this.store._notify({type:"get",path:this.path,value:this._value}),this._value)}set value(t){if(this._associated)E(this.store.state,this._path,t);else {let i=this._value;t!==i&&(this._value=t,this.store._notify({type:"set",path:this.path,value:t,oldValue:i}));}}_onObserverCreated(){typeof this.store.options.onObserverCreated=="function"&&this.store.options.onObserverCreated(this);}_onInitial(){this._options.initial!==void 0&&this.update(this._options.initial,{silent:true}),this.onInitial();}onInitial(){}onInitOptions(t){}update(t,i){this.store.update(()=>{this.value=t;},i);}silentUpdate(t){this.update(t,{silent:true});}watch(t,i){let r=this.store.watch(this.getValueWatchPath(),s=>{t.call(this,s);},i);return this._subscribers.push(r),r}getValueWatchPath(){return this.path.join(".")}emitStoreEvent(t,i){setTimeout(()=>{this.store.emit(t,i);},0);}getDepends(){return this.depends}onDependsChange(t){}attach(){!this._attached&&this.depends&&this.depends.length>0&&(this._subscribers.push(this.store.watch(this.getDepends(),this.onDependsChange.bind(this),{operates:"write"})),this.store.log(()=>`${this.toString()} subscribed to ${this.depends.map(t=>t.join(".")).join(",")}`),this._attached=true);}detach(){this._attached&&(this._subscribers.forEach(t=>{t.off();}),this._attached=false,this._subscribers=[],this.store.watchObjects.delete(this.id));}run(...t){}};var U=class extends W{static{n(this,"ComputedObject");}descriptor;context;constructor(t,i,r){super(t,i,r),this.descriptor=i,this.context=r,i.options.depends=M(this.path,this.options.depends);}toString(){return `ComputedObject<${$(this.path)}>`}get val(){return this.async?this.value.value:this.value}isDisable(t){return !this.store.options.enableComputed||!this.enable&&t!==true||t===false}run(t){throw new Error("Method not implemented.")}};var ht=class extends U{static{n(this,"SyncComputedObject");}get async(){return  false}onInitial(){this.collectDependencies();}run(t){let{first:i,operate:r}=Object.assign({first:false,operate:void 0},t);if(this.error=void 0,!i&&this.isDisable(t?.enable)){this.store.log(`Sync computed <${this.toString()}> is disabled`,"warn");return}!i&&this.store.log(()=>`Run sync computed for : ${this.toString()}`);let s=t?Object.assign({},this.options,t):this.options,o=F(this,"computed",this.context,s),a=s.initial;try{a=this.getter.call(this,o,{operate:r,first:i});}catch(u){this.error=u;}this.onDone(i,a,s);}onDone(t,i,r){let s=i;if(this.error&&A(r.onError)){let o=r.onError(this.error);o!==void 0&&(s=o);}if(t&&(this.initial=s),this.store.peep(()=>{this.value=s;}),this.error){if(!t&&this.emitStoreEvent("computed:error",{id:this.id,path:this.path,error:this.error,computedObject:this}),this.options.throwError)throw this.error}else !t&&this.emitStoreEvent("computed:done",{id:this.id,path:this.path,value:s,computedObject:this});}collectDependencies(){let t=[],i=this.store.watch(r=>{t.push(r.path);},{operates:["get"]});this.run({first:true}),i.off(),Array.isArray(this.options.depends)&&this.options.depends.length>0&&t.push(...M(this.path,this.options.depends)),this.depends=lt(t),this.attach();}onDependsChange(t){this.run({operate:t});}};function $t(e,t,i,r,s){return i==="push"?(...o)=>{let a=t.length,u=r.apply(t,o);if(t.length>a){let f=Array.from({length:t.length-a},(l,c)=>c+a);e({type:"insert",path:s,indexs:f,value:o,oldValue:void 0,parentPath:s,parent:t});}return u}:i==="pop"?()=>{let o=t.length,a=r.apply(t);return t.length===o-1&&e({type:"remove",path:s,indexs:[o-1],value:[a],oldValue:void 0,parentPath:s,parent:t}),a}:i==="splice"?(o,a,...u)=>{let f=r.apply(t,[o,a,...u]);if(f.length>0){let l=Array.from({length:f.length},(c,p)=>o+p);e({type:"remove",path:s,indexs:l,value:f,oldValue:void 0,parentPath:s,parent:t});}if(u.length>0){let l=Array.from({length:u.length},(c,p)=>o+p);e({type:"insert",path:s,indexs:l,value:u,oldValue:void 0,parentPath:s,parent:t});}return f}:i==="unshift"?(...o)=>{let a=t.length,u=r.apply(t,o);if(t.length>a){let f=Array.from({length:t.length-a},(l,c)=>c);e({type:"insert",path:s,indexs:f,value:o,oldValue:void 0,parentPath:s,parent:t});}return u}:i==="shift"?()=>{let o=t.length,a=r.apply(t);return t.length===o-1&&e({type:"remove",path:s,indexs:[0],value:[a],oldValue:void 0,parentPath:s,parent:t}),a}:i==="fill"?(o,a,u)=>{let f=r.apply(t,[o,a,u]),l=a??0,c=u??t.length,p=Array.from({length:c-l},(m,y)=>y+l),d=Array.from({length:c-l},()=>o);return e({type:"update",path:s,indexs:p,value:d,oldValue:void 0,parentPath:s,parent:t}),f}:i==="concat"?(...o)=>{let a=t.length,u=r.apply(t,o),f=Array.from({length:o.length},(l,c)=>a+c);return e({type:"insert",path:s,indexs:f,value:o,oldValue:void 0,parentPath:s,parent:t}),u}:r}n($t,"hookArrayMethods");function Mt(e){return typeof e=="number"||typeof e=="string"&&!Number.isNaN(parseInt(e))}n(Mt,"isNumber");var At=Symbol("__NOTIFY__");function Zt(e){if(this.options.validators){let t=e.join(this.options.delimiter||".");if(this.options.validators[t])return this.options.validators[t];let i=Object.keys(this.options.validators);for(let r of i)if(ot(e,r))return this.options.validators[r]}return this.options.onValidate}n(Zt,"getValidate");function Jt(e,t,i,r){let s=this._updateValidateBehavior;if(s==="none")return  true;let o=Zt.call(this,t);if(typeof o!="function")return  true;let a=true,u,f=t.join(this.options.delimiter||"."),l=n(()=>this.options.configKey?`${this.options.configKey}.${f}`:f,"getConfigKey");try{if(o.call(this,i,r,t)===!1){let p=new Q;throw s?p.behavior=s:o.validationBehavior&&(p.behavior=o.validationBehavior),p}this.options.configManager&&delete this.options.configManager.errors[l()];}catch(c){u=c,!c.behavior&&o.validationBehavior&&(c.behavior=o.validationBehavior),this.options.configManager&&(this.options.configManager.errors[l()]=c);let p=c.behavior||this.options.validationBehavior||"throw";if(p==="pass")a=true;else if(p==="ignore")a=false;else if(p==="throw-pass")a=c;else throw c}finally{this.emit("validate",{path:t,newValue:i,oldValue:r,error:u});}return a}n(Jt,"isValidPass");function Bt(e,t,i,r,s){if(G(e)||typeof e!="object"||e===null)return e;if(i.has(e))return i.get(e);let o=new Proxy(e,{get:n((a,u,f)=>{let l=Reflect.get(a,u,f);if(typeof u!="string")return l;let c=[...t,String(u)];if(typeof l=="function"||!Object.hasOwn(a,u))if(typeof l=="function"){if(Array.isArray(a)&&!Mt(u))return $t(s.notify,a,u,l,t);if(!G(l)&&Object.hasOwn(a,u)){if(typeof this.options.onObserverInitial=="function")try{if(this.options.onObserverInitial.call(this,c,l,a)===!1)return x(l),l}catch(d){this.log(`onObserverBeforeCreate error: ${d.message}`,"error");}let p=c.join(".");try{if(r.has(p)){let d=[...r.keys(),p];throw r.clear(),new X(`Find circular dependency at <"${c}">, steps: ${d.join(" -> ")}`)}return r.set(p,!0),s.createObserverObject(c,l,t,a)}finally{r.delete(p);}}else return l}else return l;return s.notify({type:"get",path:c,indexs:[],value:l,oldValue:void 0,parentPath:t,parent:a}),Bt.call(this,l,c,i,r,s)},"get"),set:n((a,u,f,l)=>{let c=Reflect.get(a,u,l),p=[...t,String(u)],d=Jt.call(this,o,p,f,c);if(d){let m=Reflect.set(a,u,f,l);if(u===At)return  true;if(m&&u!==At&&f!==c&&s.notify({type:Array.isArray(a)?"update":"set",path:p,indexs:[],value:f,oldValue:c,parentPath:t,parent:a}),d instanceof Error)throw d;return m}else return  true},"set"),deleteProperty:n((a,u)=>{let f=a[u],l=[...t,String(u)],c=Reflect.deleteProperty(a,u);return c&&u!==At&&s.notify({type:"delete",path:l,indexs:[],value:f,oldValue:void 0,parentPath:t,parent:a}),c},"deleteProperty")});return i.set(e,o),o}n(Bt,"createProxy");function Lt(e,t){let i=new Map,r=new WeakMap;return Bt.call(this,e,[],r,i,t)}n(Lt,"createReactiveObject");async function Ot(e){return new Promise((t,i)=>setTimeout(t,e))}n(Ot,"t");function Ft(e){return e instanceof Error?e:new Error(e)}n(Ft,"getError");var mt=class extends U{static{n(this,"AsyncComputedObject");}_isRunning=false;_defaultAbortController=null;_userAbortController;_firstRun=false;get async(){return  true}get value(){return super.value}set value(t){super.value=t;}get running(){return this._isRunning}onInitOptions(t){t.reentry===void 0&&(t.reentry=this.store.options.reentry);}onInitial(){this.initial=this.createAsyncComputedValue(),this.attach(),setTimeout(()=>{(this.options.immediate===true||this.options.immediate==="auto"&&this.options.initial===void 0)&&this.run({first:true});},0);}createAsyncComputedValue(){return Object.assign({[tt]:true,loading:false,timeout:0,retry:0,error:null,value:this.options.initial,progress:0,run:x(t=>this.store.computedObjects.run(this.id,Object.assign({},t))),cancel:x(()=>{this.getAbortController().abort();})})}updateComputedValue(t){let i=this.strPath,r=Object.keys(t).length;if(this.associated)this.store.update(s=>{Pt(s,this.path,t);},{batch:r>1?i:false});else {Object.assign(this.value,t);let s=r>1,o=[];Object.entries(t).forEach(([a,u])=>{let f={type:"set",path:[...this.path,a],value:u,parent:this.value};s&&(f.reply=true),this.store.operates.emit(`${this.strPath}.${a}`,f),o.push(f);}),s&&this.store.operates.emit(this.strPath,{type:"batch",path:this.path,value:o});}}async run(t){let{first:i}=t??{};if(this.isDisable(t?.enable)){this.store.log(()=>`Async computed <${this.toString()}> is disabled`,"warn");return}this.error=void 0,this._firstRun=true,!i&&this.store.log(()=>`Run async computed for : ${this.toString()}`);let r=t?Object.assign({first:i},this.options,t):this.options,s=F(this,"computed",this.context,r),{reentry:o}=r;if(this._isRunning&&!o){this.store.log(()=>`Async computed: ${this.toString()} is running, can't reentry`,"warn"),this.emitStoreEvent("computed:cancel",{path:this.path,id:this.id,reason:"reentry",computedObject:this});return}this._isRunning=true;try{return await this.executeGetter(s,r)}finally{this._isRunning=false;}}createComputeProgressbar(t){let{max:i=100,min:r=0,value:s=0}=Object.assign({},t);return this.updateComputedValue({progress:s}),{value:n(o=>{o>i&&(o=i),o<r&&(o=r),this.updateComputedValue({progress:o});},"value"),end(){this.value(i);}}}getAbortController(t){if(t&&typeof t.abortController=="function"){let i=t.abortController();i&&i instanceof AbortController&&(this._userAbortController=i);}return this._userAbortController?this._userAbortController:(this._defaultAbortController||(this._defaultAbortController=new AbortController),this._defaultAbortController.signal.aborted&&(this._defaultAbortController=new AbortController),this._defaultAbortController)}setTimeoutControl(t,i,r){let{timeout:s}=r,[o=0,a=0]=Array.isArray(s)?s:[s,0],u,f;return o>0&&(i.timeout=a>1?a:o,f=setTimeout(()=>{t.hasTimeout=true,t.hasError=true,t.error="TIMEOUT",typeof t.timeoutCallback=="function"&&t.timeoutCallback(),clearInterval(u),this.updateComputedValue({loading:false,error:"TIMEOUT",timeout:0});},o),a>1&&(u=setInterval(()=>{this.updateComputedValue({timeout:a--}),a===0&&clearInterval(u);},o/(a+1)))),{clear:n(()=>{clearTimeout(f),clearInterval(u);},"clear"),enable:o>0}}async executeGetter(t,i){let{retry:r=[0,0]}=i,[s,o]=Array.isArray(r)?r:[Number(r),0],a,u=this.getAbortController(i),f={onTimeout:n(m=>{a=m;},"onTimeout"),getProgressbar:this.createComputeProgressbar.bind(this),getSnap:n(m=>m,"getSnap"),cancel:u.abort,extras:i.extras,operate:i.operate,first:i.first,abortSignal:u.signal},l={error:null,hasError:false,hasTimeout:false,hasAbort:false,timeoutCallback:a};u.signal.addEventListener("abort",()=>{l.hasAbort=true;});let c={clear:n(()=>{},"clear"),enable:false},p,d=n(m=>Object.assign(l,m),"updateCtx");for(let m=0;m<s+1;m++){let y={};try{let v={loading:!0};if(l.hasError&&(v.error=null),s>0&&(v.retry=m>0?s-m+1:0),m>0&&d({error:null,hasError:!1,hasTimeout:!1}),c=this.setTimeoutControl(l,v,i),this.updateComputedValue(v),l.hasAbort)throw new H;if(p=await this.getter.call(this,t,f),l.hasAbort)throw new H;l.hasTimeout||(y.value=p,c.enable&&(y.timeout=0));}catch(v){if(l.hasError=true,l.error=v,l.hasTimeout||(y.error=Ft(v).message),A(i.onError)){let wt=i.onError(v);wt!==void 0&&(y.value=wt);}}finally{c.clear(),m===s&&(l.hasTimeout&&(y.error=l.error),s>0&&(y.retry=0)),y.loading=false,this.updateComputedValue(y);}l.hasError&&s>0&&o>0&&m<s&&await Ot(o);}l.hasAbort?this.emitStoreEvent("computed:cancel",{path:this.path,id:this.id,computedObject:this}):l.hasError||l.hasTimeout?(this.error=l.error,this.emitStoreEvent("computed:error",{path:this.path,id:this.id,error:l.error,computedObject:this})):this.emitStoreEvent("computed:done",{path:this.path,id:this.id,value:p,computedObject:this}),this.onDoneCallback(i,l.error,l.hasAbort,l.hasTimeout,t,p);}onDoneCallback(t,i,r,s,o,a){typeof t.onDone=="function"&&t.onDone.call(this,{id:this.id,path:this.path,value:a,error:i,abort:r,timeout:s,scope:o});}onDependsChange(t){this.store.log(()=>`AsyncComputed<${this.id}> is running by depends ${t.type}/${t.path.join(".")} operate `),this.run({operate:t,first:!this._firstRun});}getValueWatchPath(){let t=this.path.join(".");return [`${t}.*`,t]}getDepends(){return super.getDepends().map(i=>{if(i.length===0)return i;for(let r of this.store.computedObjects.values())if(j(r.path,i)&&r.async)return [`${i}.value`];return i})}};function Wt(){let e=arguments[0],t=typeof arguments[1]=="function"?arguments[1]:()=>true,i=typeof arguments[1]=="object"?arguments[1]:arguments[2],r=Object.assign({depends:[],enable:true,objectify:true,filter:t},i),s=n(()=>({type:"watch",getter:e,options:r}),"descriptorBuilder");return s[C]=true,s}n(Wt,"watch");var dt=class extends Map{static{n(this,"WatchObjects");}store;_watcher={off:n(()=>{},"off")};_enable=true;constructor(t){super(),this.store=t;}get enable(){return this._enable}set enable(t){this._enable=t;}set(t,i){return super.size===0&&this.createWacher(),super.set(t,i)}createWacher(){this._watcher=this.store.watch("**",({path:t,value:i})=>{if(!this._enable)return;let r=t[0].startsWith("#")?i:g(this.store.state,t);for(let s of this.values())s.isMatched(t,r)&&s.run(t,r);});}reset(){this._watcher&&this._watcher.off();for(let t of this.values())t.reset();this.createWacher();}create(){let t=w(arguments[0])?arguments[0]:Wt(...arguments)();return this.store._createWatch(t)}enableGroup(t,i=true){for(let r of this.values())r.options.group===t&&(r.options.enable=i);}};var gt=class extends W{static{n(this,"WatchObject");}store;context;_cache;constructor(t,i,r){if(super(t,i,r),this.store=t,this.context=r,typeof this.options.filter!="function")throw new Error("watch options.filter must be a function")}get filter(){return this.options.filter}get cache(){return this._cache||(this._cache={}),this._cache}toString(){return `WatchObject<${this.id}>`}onInitial(){}isMatched(t,i){return st(t,this.path)?false:this.filter(t,i)}reset(){this._cache={},this.value=this.initial;}run(t,i){if(!this.enable){this.store.log(`WatchObject <${this.toString()}> is disabled`);return}try{let r=this.getter?.call(this,{path:t,value:i},this);this.value=r,this.emitStoreEvent("watch:done",{value:r,watchObject:this});}catch(r){this.emitStoreEvent("watch:error",{error:r,watchObject:this});}}};function Et(e,t){return new Proxy(e,{get(r,s,o){return s==="on"?(a,u,f)=>e.on(`${t}${"."}${a}`,(l,c)=>u(l,c.slice(t.length+1)),f):s==="once"?(a,u)=>e.once(`${t}${"."}${a}`,(f,l)=>{u(f,l.slice(t.length+1));}):s==="off"?(a,u)=>e.off(`${t}${"."}${a}`,u):s==="emit"?(a,u)=>e.emit(`${t}${"."}${a}`,u):s==="wait"?async(...a)=>{if(typeof a[0]=="string")return a[0]=`${t}${"."}${a[0]}`,e.wait(...a);if(typeof a[0]=="function"){let u=a[0];return a[0]=(f,l)=>{f.startsWith(t)&&u(f.slice(t.length+1),l);},e.wait(...a)}}:s==="offAll"?()=>{for(let[a]of e.listeners.entries())a!=="*"&&typeof a=="string"&&a.startsWith(`${t}.`)&&e.listeners.delete(a);}:s==="onAny"?a=>e.on(`${t}${"."}**`,(u,f)=>{a(u,f.slice(t.length+1));}):s==="scope"?a=>Et(e,`${t}${"."}${a}`):Reflect.get(r,s,o)}})}n(Et,"createEventEmitterScope");var q=class{static{n(this,"EventEmitter");}_listeners=new Map;get listeners(){return this._listeners}on(){let t=arguments[0],i=arguments[1],r=arguments[2],s=i;return t==="**"?this.addHandler("*",s,r):String(t).includes("*")?(s=n((o,a)=>{ot(a,t)&&i(o,a);},"phandler"),this.addHandler("*",s,r)):this.addHandler(t,s,r),{off:n(()=>this.off(t,s),"off")}}addHandler(t,i,r){let s=this._listeners.get(t);s?r?s.unshift(i):s.push(i):this._listeners.set(t,[i]);}once(t,i){let r=n((s,o)=>{try{i(s,o);}finally{this.off(o,r);}},"plistener");return this.on(t,r)}off(t,i){String(t).includes("*")&&(t="*");let r=this._listeners.get(t);r&&(i?r.splice(r.indexOf(i)>>>0,1):this._listeners.set(t,[]));}offAll(){this._listeners.clear();}onAny(t){return this.on("**",t)}wait(){let t=typeof arguments[0],i=t==="string"?arguments[0]:void 0,r=arguments[1]||0,s=t==="function"?t:void 0,o;return new Promise((a,u)=>{let f;i?f=this.once(i,l=>{clearTimeout(o),a(l);}):typeof s=="function"&&(f=this.onAny((l,c)=>{s(c,l)!==false&&(f.off(),clearTimeout(o),a(l));})),r>0&&(o=setTimeout(()=>{f.off(),u(new Error("timeout"));},r));})}emit(t,i){let r=this._listeners.get("*");r&&r.slice().map(s=>s(i,t)),r=this._listeners.get(t),r&&r.slice().map(s=>s(i,t));}scope(t){return Et(this,t)}};function Ut(e){let t;return I(e)?t=e():typeof e=="function"&&(t={type:"computed",getter:e,options:Object.assign({},rt(),{async:et(e)})}),t}n(Ut,"getObserverDescriptor");function vt(e,t){if(t==="*")return  true;if(t==="write"){if(e.type==="get")return}else if(t==="read"){if(e.type!=="get")return}else if(Array.isArray(t)&&t.length>0&&!t.includes(e.type))return;return  true}n(vt,"isMatchOperates");function Nt(e,t=()=>{}){e=e.replace(/^\s*`{3,}\w*(?:\r?\n|\n)/,"").replace(/^\s*`+\s*/,""),e=e.replace(/\s*`{3,}\s*$/,"").replace(/\s*`+\s*$/,""),e=e.replace(/^[\f\t\r\n]+/,""),e=e.replace(/^[\\]+(?=(?:async|function|\(|[A-Za-z_$]))/,"");let i=/^\s*(async\s+)?function(?:\s+\w+)?\s*\(([^)]*)\)\s*\{([\s\S]*)\}\s*;?\s*$/m.exec(e),r=/^\s*(async\s+)?\(([^)]*)\)\s*=>\s*(?:\{([\s\S]*)\}|(.+))\s*;?\s*$/m.exec(e),s=/^\s*(async\s+)?([A-Za-z_$][\w$]*)\s*=>\s*(?:\{([\s\S]*)\}|(.+))\s*;?\s*$/m.exec(e);if(!i&&!r&&!s)return;let o=false,a=[],u="";if(i){let[,c,p,d]=i;o=!!c,a=(p||"").split(",").map(m=>m.trim()).filter(Boolean),u=d;}else if(r){let[,c,p,d,m]=r;o=!!c,a=(p||"").split(",").map(y=>y.trim()).filter(Boolean),u=d||`return ${m}`;}else if(s){let[,c,p,d,m]=s;o=!!c,a=p?[p]:[],u=d||`return ${m}`;}let f=Object.getPrototypeOf(async function(){}).constructor,l=o?f:Function;try{return new l(...a,u)}catch{return t}}n(Nt,"parseFunc");var yt=class extends q{static{n(this,"AutoStore");}_data;computedObjects;watchObjects;_operates=new q;_options;_silenting=false;_batching=false;_batchOperates=[];_updateFlags=0;_peeping=false;_updateValidateBehavior;_updatedState;_updatedWatcher;_delimiter=".";_configManager;types={rawState:void 0,state:void 0};constructor(t,i){super(),this._options=N({id:at(),debug:false,enableComputed:true,reentry:true,resetable:false,delimiter:".",log:It},i),this._delimiter=this._options.delimiter,this.computedObjects=new pt(this),this.watchObjects=new dt(this),this.subscribeCallbacks(),this._data=Lt.call(this,t||{},{notify:this._notify.bind(this),createObserverObject:this.createObserverObject.bind(this)}),this.getSnap=this.getSnap.bind(this),this.watch=this.watch.bind(this),this.update=this.update.bind(this),this.peep=this.peep.bind(this),this.silentUpdate=this.silentUpdate.bind(this),this.batchUpdate=this.batchUpdate.bind(this),this.trace=this.trace.bind(this),this.collectDependencies=this.collectDependencies.bind(this),this.installExtends(),ut(this._data,this._onFirstEachState.bind(this)),this._options.resetable&&(this.resetable=true),this._options.debug&&typeof globalThis.__AUTOSTORE_DEVTOOLS__=="object"&&globalThis.__AUTOSTORE_DEVTOOLS__.add(this),this.emit("load",this);}get id(){return this._options.id}get state(){return this._data}get operates(){return this._operates}get options(){return this._options}get silenting(){return this._silenting}get delimiter(){return this._delimiter}get batching(){return this._batching}get peeping(){return this._peeping}get resetable(){return this._options.resetable}get configManager(){return this.options.configManager}set resetable(t){if(t){if(this._updatedWatcher)return;this._updatedState={},this._updatedWatcher=this.watch(({path:i,oldValue:r})=>{if(i.length===0)return;let s=i.join(this._delimiter);!s.startsWith("#")&&!(s in this._updatedState)&&(this._updatedState[s]=r);},{operates:"write"});}else this._updatedWatcher&&(this._updatedWatcher.off(),this._updatedWatcher=void 0),this._updatedState={};this._options.resetable=t;}reset(t){if(this._options.resetable&&this._updatedState)try{this.batchUpdate(i=>{let r=t?`${t}${this._delimiter}`:"";Object.entries(this._updatedState).forEach(([s,o])=>{s.startsWith(r)&&E(i,s.split(this._delimiter),o);});});}finally{this.emit("reset",t);}else this.log("resetable option is not enabled","warn");}_onFirstEachState({value:t,path:i}){typeof t=="string"&&t.startsWith("```")&&t.endsWith("```")&&this.update(r=>{let s=Nt(t.slice(3,t.length-3));x(s),E(r,i,s);},{silent:true});}log(t,i){this._options.debug&&this.options.log.call(this,t,i);}installExtends(){let t=globalThis.__AUTOSTORE_EXTENDS__;Array.isArray(t)&&t.forEach(i=>{typeof i=="function"&&i(this);});}subscribeCallbacks(){this._options.onComputedCreated&&this.on("computed:created",this._options.onComputedCreated.bind(this)),this._options.onComputedDone&&this.on("computed:done",this._options.onComputedDone.bind(this)),this._options.onComputedError&&this.on("computed:error",this._options.onComputedError.bind(this)),this._options.onComputedCancel&&this.on("computed:cancel",this._options.onComputedCancel.bind(this)),this._options.onObserverBeforeCreate&&this.on("observer:beforeCreate",this._options.onObserverBeforeCreate.bind(this));}_notify(t){this._peeping&&t.type==="get"||(this._batching&&this._batchOperates.push(t),!this._silenting&&(t.flags=this._updateFlags,this.operates.emit(t.path.join(this._delimiter),t)));}watch(){let t=typeof arguments[0]=="function"||["*","**"].includes(arguments[0])||Array.isArray(arguments[0])&&arguments[0].length===0,i=typeof arguments[0]=="function"?arguments[0]:arguments[1],r=arguments.length>=2&&typeof arguments[arguments.length-1]=="object"?arguments[arguments.length-1]:void 0,s=n((o,a)=>u=>{if(vt(u,o)&&!(typeof a=="function"&&!a(u)))try{if(this._peeping=!0,u.type==="batch"){let f=u.value.filter(l=>vt(l,o));if(f.length>0)u.value=f;else return}i(u);}finally{this._peeping=false;}},"createEventHandler");if(t){let{operates:o,filter:a}=Object.assign({once:false,operates:"write"},r),u=s(o,a);return this.operates.onAny(u)}else {let o=arguments[0],a=Array.isArray(o)?o.map(m=>typeof m=="string"?m:m.join(this._delimiter)):[o],{once:u,operates:f,filter:l}=Object.assign({once:false,operates:"write"},r),c=u?this.operates.once.bind(this.operates):this.operates.on.bind(this.operates),p=[],d=s(f,l);return a.forEach(m=>{p.push(c.call(this,m,d));}),{off:n(()=>p.forEach(m=>{m.off();}),"off")}}}createObserverObject(t,i,r,s){if(this.options.configManager&&ct(i))return this.options.configManager.add(this,t,i);{let o=Ut(i),a={path:t,value:i,parentPath:r,parent:s};if(o){if(o.type==="computed")return this._createComputed(o,a)?.initial;if(o.type==="watch")return this._createWatch(o,a)?.initial}else return i}}_createComputed(t,i){let r;return this.emit("observer:beforeCreate",t),t.options.async?r=new mt(this,t,i):r=new ht(this,t,i),r&&(r.silentUpdate(r.initial),r.options.objectify&&this.computedObjects.set(r.id,r),this.emit("computed:created",r),this.emit("observer:afterCreate",t)),r}_createWatch(t,i){this.emit("observer:beforeCreate",t);let r=new gt(this,t,i);return this.watchObjects.set(r.id,r),this.emit("watch:created",r),this.emit("observer:afterCreate",t),r}silentUpdate(t){this.update(t,{silent:true});}batchUpdate(t){this.update(t,{batch:true,validate:"pass"});}update(t,i){let{batch:r=false,reply:s=true,silent:o=false,peep:a=false,flags:u=0,validate:f}=Object.assign({},i);if(typeof t=="function"){this._updateFlags=u,this._updateValidateBehavior=f,o&&(this._silenting=true),r&&(this._batching=true,this._silenting=true),a&&(this._peeping=true);try{let l=t(this.state);if(r&&Dt(l))throw new Error("Batch update method can't be async function")}finally{this._silenting=false,this._batching=false,this._peeping=false,this._updateFlags=0,this._updateValidateBehavior=void 0,this.replyBatchOperates(s,r);}}else throw new Error("update method must provide a function argument")}replyBatchOperates(t,i){if(this._batchOperates.length>0){let r=[...this._batchOperates];this._batchOperates=[],t&&r.forEach(s=>{s.reply=true,this._notify(s);});try{let s=i===!0?Vt:String(i);this.operates.emit(s,{type:"batch",path:[s],value:r});}finally{this._batchOperates=[];}}}peep(){let t=typeof arguments[0]=="function"?()=>arguments[0](this.state):()=>g(this.state,Array.isArray(arguments[0])?arguments[0]:arguments[0].split(this._delimiter));this._peeping=true;try{return t()}finally{this._peeping=false;}}collectDependencies(t,i="*"){let r=[],s=this.watch(o=>{r.push(o.path);},{operates:i});try{t();}finally{s.off();}return lt(r)}trace(t,i="*"){let r;return {stop:n(()=>r?.off(),"stop"),start:n(async s=>{let o=[];return new Promise(a=>{r=this.watch(u=>{o.push(u),s?.(u)&&(r.off(),a(o));},{operates:i}),Promise.resolve(t()).finally(()=>{typeof s!="function"&&(r.off(),a(o));});})},"start")}}destroy(){this.offAll(),this._operates.offAll(),this.watchObjects.clear(),this.computedObjects.clear(),this.emit("unload",this);}getSnap(t){let{reserveAsync:i,entry:r,includeFunc:s}=Object.assign({reserveAsync:true},t);return ft(r?g(this._data,r):this._data,{reserveAsync:i,includeFunc:s})}get(t,i){let{defaultValue:r,timeout:s=0,expandAsync:o=false,waitAsyncDone:a=false}=Object.assign({},i),u=Array.isArray(t)?t:t.split(this.delimiter),f=g(this.state,u,r);return _(f)?f.loading&&a?new Promise((l,c)=>{let p,d;s>0&&(p=setTimeout(()=>{d?.off(),c(new V);},s)),d=this.on("computed:done",({path:m})=>{j(u,m)&&(clearTimeout(p),d?.off(),l(o?f.value:f));});}):o?f.value:f:f}toString(){return `AutoStore<${this.id}>`}};var Ht=class extends yt{static{n(this,"ConfigManager");}source;_errors;constructor(t){super({}),this.source=t;}get fields(){return this.state}get size(){return Object.keys(this.fields).length}get errors(){return this._errors||(this._errors={}),this._errors}async load(){let t=await this.source.load();Object.entries(t).forEach(([i,r])=>{let s=i.split(".");this.update(o=>{let a=g(o,s);a?E(o,s,{value:r}):a.value=r;},{silent:true});});}async save(){let t=Object.entries(this.state).reduce((i,[r,s])=>(i[r]=s.value,i),{});await this.source.save?.(t);}add(t,i,r){let s=ct(r)?r():r,o=Array.isArray(i)?i:i.split(t.options.delimiter),a=o.join(t.options.delimiter),u=o;t.options.configKey&&u.splice(0,0,t.options.configKey);let f=s.value,l=this.getConfigValue(u);if(l!==void 0&&(s.value=l),A(s.schema.onValidate)){let c=s.schema.onValidate,p=s.schema.validationBehavior||"throw";s.schema.onValidate=function(...d){return c.apply(this,d)},s.schema.onValidate.getErrorMessage=d=>{let m=s.schema.invalidTips;return typeof m=="string"?m:typeof m=="function"?m({error:d.message,stack:d.stack}):d.message},s.schema.onValidate.validationBehavior=p,t.options.validators||(t.options.validators={}),t.options.validators[a]=s.schema.onValidate;}else t.options.validators&&delete t.options.validators[a];return this._createValueProxy(s,t,o),this.update(c=>{E(c,[u.join(".")],s);},{silent:true}),f}_createValueProxy(t,i,r){let s=new WeakRef(i);return Object.defineProperty(t,"value",{get(){let o=s.deref();if(o)return g(o.state,r)},set(o){s.deref()?.update(u=>{E(u,r,o);});}})}getConfigValue(t){return this.peep(i=>g(i,[...t,"value"]))}};function Qt(e){Ct(e)&&ut(e,({value:t,key:i,parent:r})=>{A(t)&&(i.startsWith("on")||i.startsWith("render")||i.startsWith("to"))&&(r[i]=x(t));});}n(Qt,"markRawSchema");function kt(e){let t={value:e[0],schema:Object.assign({validationBehavior:"throw-pass"},e[1])};return Qt(t.schema),t}n(kt,"parseSchemaArgs");var Gt=n(function(e,t){let i=kt([e,t]),r=e,s=Array.isArray(r)?"array":typeof r;typeof r=="object"&&x(r);let o=n(()=>({value:r,datatype:s,schema:i.schema}),"builder");return o[D]=true,o},"schema"),Bu=Gt;function T(e,t){return n(function(r,s){let o=Object.assign({},s);return typeof o.onValidate!="function"&&(o.onValidate=e),o.invalidTips||(o.invalidTips=t),Gt(r,o)},"typeSchema")}n(T,"createTypeSchemaBuilder");var te={number:T(e=>typeof e=="number","must be a number"),string:T(e=>typeof e=="string","must be a string"),boolean:T(e=>typeof e=="boolean","must be a boolean"),date:T(e=>e instanceof Date,"must be a date"),bigint:T(e=>typeof e=="bigint","must be a bigint"),array:T(e=>Array.isArray(e),"must be an array"),object:T(e=>typeof e=="object","must be an object")},Lu=te;exports.ASYNC_COMPUTED_VALUE=tt;exports.AbortError=H;exports.AsyncComputedObject=mt;exports.AutoStore=yt;exports.AutoStoreError=O;exports.BATCH_UPDATE_EVENT=Vt;exports.ComputedObject=U;exports.ComputedObjects=pt;exports.ConfigManager=Ht;exports.CyleDependError=X;exports.DELETE_FLAG=Ar;exports.EMPTY=xr;exports.EventEmitter=q;exports.InvalidComputedArgumentsError=z;exports.InvalidDependsError=J;exports.InvalidScopeError=Z;exports.OBSERVER_DESCRIPTOR_BUILDER_FLAG=C;exports.OBSERVER_DESCRIPTOR_FLAG=Rt;exports.ObserverObject=W;exports.ObserverScopeRef=L;exports.PATH_DELIMITER=h;exports.SKIP_PROXY_FLAG=k;exports.SyncComputedObject=ht;exports.TimeoutError=V;exports.VALUE_SCHEMA_BUILDER_FLAG=D;exports.ValidateError=Q;exports.WatchObject=gt;exports.WatchObjects=dt;exports.calcDependPaths=M;exports.computed=it;exports.configurable=Bu;exports.createAsyncComptuedValue=Gs;exports.createObserverObject=Rs;exports.createTypeSchemaBuilder=T;exports.defineExtend=Es;exports.delay=zi;exports.forEachObject=ut;exports.getAsyncVal=Ws;exports.getComputedId=Li;exports.getDepends=ns;exports.getId=at;exports.getMapVal=nt;exports.getSnap=Xt;exports.getSnapshot=ft;exports.getVal=g;exports.isAbsolutePath=xt;exports.isAsyncComputedValue=_;exports.isComputedDescriptorParameter=Is;exports.isEq=st;exports.isFunction=A;exports.isMap=P;exports.isObserverDescriptor=w;exports.isObserverDescriptorBuilder=I;exports.isPathEq=j;exports.isPathMatched=ot;exports.isPlainObject=Ct;exports.isPrimitive=xs;exports.isPromise=Dt;exports.isProxy=fi;exports.isRaw=G;exports.isRelPath=Js;exports.isSchemaBuilder=ct;exports.isValueSchema=Xs;exports.joinValuePath=$;exports.markRaw=x;exports.noRepeat=lt;exports.normalizeDeps=bt;exports.pathIsExists=cs;exports.pathStartsWith=ts;exports.s=Lu;exports.schema=Gt;exports.schemas=te;exports.setVal=E;exports.updateObjectVal=Pt;exports.watch=Wt;return exports;})({});//# sourceMappingURL=index.global.js.map
//# sourceMappingURL=index.global.js.map